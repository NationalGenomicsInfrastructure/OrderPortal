{# Order page. #}

{% block head_title %}Order '{{ order.get('title') or order['_id'] }}'{% end %}
{% block body_title %}Order '{{ order.get('title') or order['_id'] }}'{% end %}

{% extends "base.html" %}

{% block meta_content %}

{% if is_editable %}
<form action="{{ reverse_url('order_edit', order['_id']) }}"
      role="form" method='GET'>
  <div class="form-group">
    <button type="submit"
	    class="btn btn-primary glyphicon glyphicon-edit">
      Edit
    </button>
  </div>
</form>

<br>
<form action="{{ reverse_url('order', order['_id']) }}"
      role="form" method='POST'>
  {% module xsrf_form_html() %}
  <div class="form-group">
    <input type="hidden" name="_http_method" value="delete">
    <button type="submit"
	    class="btn btn-danger glyphicon glyphicon-minus"
	    onclick="return confirm('Cannot be undone! Really delete?');">
      Delete
    </button>
  </div>
</form>
{% end %} {# if is_editable #}

{% for target in targets %}
<br>
<form action="{{ reverse_url('order_transition', order['_id'], target['identifier']) }}"
      role="form" method='POST'>
    <button type="submit" class="btn btn-warning">
      {% module Icon(target['identifier']) %}
      {{ target.get('label', target['identifier'].capitalize()) }}
    </button>
</form>
{% end %}

{% end %} {# block meta_content #}

{% block main_content %}
<div class="panel panel-default">
  <div class="panel-heading">Metadata</div>
  <div class="panel-body">

    <table class="table table-condensed table-fields table-noborder">
      <tr>
	<th>Owner</th>
	<td colspan="2">
	  <a href="{{ reverse_url('user', order['owner']) }}">
	    {{ order['owner'] }}
	  </a>
	</td>
      </tr>

      <tr>
	<th>Status</th>
	<td>{% module Icon(order['status'], label=True) %}</td>
	<td>{{ status['description'] }}</td>
      </tr>

      <tr>
	<th>Modified</th>
	<td class="localtime">{{ order['modified'] }}</td>
	<td>
	  <a href="{{ reverse_url('order_logs', order['_id']) }}">
	    {% module Icon('logs', label=True) %}
	  </a>
	</td>
      </tr>
    </table>

  </div>
</div>

<div class="panel panel-default">
  <div class="panel-heading">Specification</div>
  <div class="panel-body">

    {% set stack = [0] %}
    <table class="table table-condensed table-noborder table-hierarchy">
      {% for field in fields %}
	  {% while field['depth'] < stack[-1] %}
	    {% set stack.pop() %}
		  </table>
		</div>
	      </div>
	    </td>
	  </tr>
	   {% end %}
        {% if field['type'] == 'group' %}
	  {% set stack.append(field['depth'] + 1) %}
          <tr>
	    <td colspan="3">
	      <div class="panel panel-default">
		<div class="panel-heading">
		  {{ field.get('label') or field['identifier'].capitalize() }}
		</div>
		<div class="panel-body">
		  <table class="table table-condensed table-noborder table-hierarchy">
        {% else %}
	  <tr>
	    <th>
	      {{ field.get('label') or field['identifier'].capitalize() }}
	    </th>
	    <td>{{ order['fields'][field['identifier']] or '-' }}</td>
	    <td>{{ field.get('description') or '-' }}</td>
	  </tr>
	{% end %}
      {% end %} {# for field in fields #}
      {% while stack.pop() %}
	      </table>
	    </div>
	  </div>
	</td>
      {% end %}
    </table>

  </div>
</div>

{#
<div class="panel panel-default">
  <div class="panel-heading">Test level 1</div>
  <div class="panel-body">
    <table class="table table-condensed table-noborder">
      <tr>
	<th>Field</th>
	<td>Value</td>
      </tr>
      <tr>
	<td colspan="2">
	  <div class="panel panel-default">
	    <div class="panel-heading">Test level 2</div>
	    <div class="panel-body">
	    </div>
	  </div>
	</td>
      </tr>
    </table>
  </div>
</div>
#}

{% end %} {# block main_content #}
