{# Order edit fields recursive display. #}

{% for field in fields %}

{# Check if field may not be read or edited. #}
{% if (field['restrict_read'] or field['restrict_write']) and not is_staff %}
{% continue %}
{% end %}

{% set label = field.get('label') or field['identifier'].capitalize().replace('_', ' ') %}

{# Is there a visibility condition? #}
{% set visible_if_select_field = field.get('visible_if_select_field') %}

{% if field['type'] == constants.GROUP %}

{% if visible_if_select_field %}
<div class="panel panel-default visible-if-select"
     data-select-id="{{ visible_if_select_field }}"
     data-select-val="{{ field.get('visible_if_select_value') or '' }}">
{% else %}
<div class="panel panel-default">
{% end %}
  <div class="panel-heading">
    <h4>
      {{ label }}
      <small>
	{% if field['restrict_read'] %}
	[Read: Staff only]
	{% end %}
	{% if field['restrict_write'] %}
	[Write: Staff only]
	{% end %}
	{{ field.get('description') or '' }}
	{% if field['identifier'] in order['invalid'] %}
	<span class="text-danger glyphicon glyphicon-remove">
	  {{ order['invalid'][field['identifier']] }}
	</span>
	{% else %}
	<span class="text-success glyphicon glyphicon-ok">
	</span>
	{% end %}
      </small>
    </h4>
  </div>
  <div class="panel-body">
    {# Recursion: 'include' cannot be used! #}
    {% module Template('order_edit_fields.html', order=order, fields=field['fields'], is_staff=is_staff) %}
  </div>
</div>

{% else %}

{% if visible_if_select_field %}
<div class="form-group has-feedback visible-if-select"
     data-select-id="{{ visible_if_select_field }}"
     data-select-val="{{ field.get('visible_if_select_value') or '' }}">
{% else %}
<div class="form-group has-feedback">
{% end %}
  <div class="row">
    <div class="col-md-8">
      <label class="control-label" for="{{ field['identifier'] }}">
	{{ label }}
	{% if field['identifier'] in order['invalid'] %}
	<span class="text-danger glyphicon glyphicon-remove">
	  {{ order['invalid'][field['identifier']] }}
	</span>
	{% else %}
	<span class="text-success glyphicon glyphicon-ok">
	</span>
	{% end %}
      </label>
      {% set value = order['fields'][field['identifier']] %}
      {% if field['type'] == constants.SELECT %}
      <select class="form-control"
	      name="{{ field['identifier'] }}"
	      id="{{ field['identifier'] }}">
	{% if not field['required'] %}
	  {% if value is None %}
	  <option selected value="">[no value]</option>
	  {% else %}
	  <option value="">[no value]</option>
	  {% end %}
	{% end %}
	{% for v in field['select'] %}
	  {% if v == value %}
	  <option selected>{{ v }}</option>
	  {% else %}
	  <option>{{ v }}</option>
	  {% end %}
	{% end %}
      </select>
      {% elif field['type'] == constants.TEXT %}
      <textarea class="form-control"
		name="{{ field['identifier'] }}"
		id="{{ field['identifier'] }}"
		>{{ value or '' }}</textarea>
      {% elif field['type'] == constants.BOOLEAN %}
      {# Simplifies a lot when a Select element is used rather than Radio. #}
      <select class="form-control"
	      id="{{ field['identifier'] }}"
	      name="{{ field['identifier'] }}">
	<option value="__none__"
		{{ value is None and 'selected' or '' }}>[undef]</option>
	<option value="true"
		{{ value == True and 'selected' or '' }}>True</option>
	<option value="false"
		{{ value == False and 'selected' or '' }}>False</option>
      </select>
      {% elif field['type'] == constants.MILESTONE %}
      <div class="row" id="{{ field['identifier'] }}">
	<div class="col-md-4">
	  <div class="radio">
	    <label class="radio-inline">
	      <input type="radio"
		     name="{{ field['identifier'] }}"
		     value="true"
		     {{ order['fields'].get(field['identifier'], False) and 'checked' or '' }}>
	      Reached
	    </label>
	    <label class="radio-inline">
	      <input type="radio"
		     name="{{ field['identifier'] }}"
		     value="false"
		     {{ not order['fields'].get(field['identifier'], False) and 'checked' or '' }}>
	      Not reached
	    </label>
	  </div>
	</div>
	<div class="col-md-5">
	  {# Multiple input fields with same name handled by server for this. #}
	  <input type="date" class="form-control"
		 name="{{ field['identifier'] }}"
		 value="{{ order['fields'][field['identifier']] or '' }}">
	</div>
      </div>
      {% else %}
      <input type="text" class="form-control"
	     name="{{ field['identifier'] }}"
	     id="{{ field['identifier'] }}"
	     value="{{ order['fields'][field['identifier']] or '' }}">
      {% if field['required'] %}
      <span style="color:red; margin-right: 1em;"
	    class="glyphicon glyphicon-star form-control-feedback"
	    aria-hidden="true">
      </span>
      {% end %}
      {% end %}
    </div>
  </div>
  <span class="help-block">
    {{ field.get('description') or '' }}
    {% if field['type'] == constants.TEXT %}
    <a href="http://daringfireball.net/projects/markdown/">
      Markdown
    </a>
    format is used.
    {% end %}
  </span>
</div>
{% end %} {# if field['type'] == constants.GROUP #}
{% end %} {# for field in fields #}
