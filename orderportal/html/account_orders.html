{# List of all orders for an account. #}

{% extends "base.html" %}

{% block head_title %}Orders {{ account['email'] }}{% end %}

{% block body_title %}
{% module Icon('order', title='Orders', label=True) %}
{% module Entity(account) %}
{% end %}

{% block header_css %}
<link rel="stylesheet" type="text/css"
      href="{{ settings['DATATABLES_CSS_URL'] }}">
{% end %}

{% block container %}
<div class="container-fluid">
{% end %}

{% block content %}

<div class="row">
  <div class="col-md-4 col-md-offset-8">
    {% if is_staff or account['email'] == current_user['email'] %}
    <a href="{{ reverse_url('account_groups_orders', account['email']) }}">
      {% module Icon('group') %}
      All orders in account's groups
    </a>
    {% end %}
  </div>
</div>

<br>

<div class="row">
  <div class="col-md-12">
    <table id="orders"
	   class="table table-striped table-condensed"
	   data-page-length="25">
      <thead>
	<tr>
	  <th>{% module Icon('order', label=True) %}</th>
	  <th width="30%">Title</th>
	  {% if is_staff %}
	  <th>{% module Icon('form', label=True) %}</th>
	  {% end %} {# if is_staff #}
	  {% for f in settings['ORDERS_LIST_FIELDS'] %}
	  <th>{{ f['identifier'].capitalize().replace('_', ' ') }}</th>
	  {% end %}
	  <th>Status</th>
	  {% for s in settings['ORDERS_LIST_STATUSES'] %}
	  <th>{% module Icon(s, label=True) %}</th>
	  {% end %}
	  <th>Modified</th>
	</tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
</div>
{% end %} {# block content #}

{% block javascript_code %}
<script>
$(document).ready(function() {
    $('.refresh').change(function () {
	$('#refresh').submit();
    });
});
</script>
{% end %}

{% block javascript_code %}
<script src="{{ settings['DATATABLES_JS_URL'] }}"></script>
<script src="{{ settings['DATATABLES_BOOTSTRAP_JS_URL'] }}"></script>
<script>
$(document).ready(function() {
  $(".refresh").change(function () {
    $("#refresh").submit();
  });
  $("#orders").DataTable( {
    pagingType: "full_numbers",
    order: [[{{ order_column }}, "desc"]],
    ajax: {
      url: "/api/v1/account/{{ account['email']}}/orders",
      dataSrc: "data"
    },
    columns: [
      {data: "identifier",
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         $(nTd).html("<a href='"+oData.href+"'>"+oData.identifier+"</a>");
       }
      },
      {data: "title"},
{% if is_staff %}
      {data: "form_title",
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         $(nTd).html("<a href='"+oData.form_href+"'>"+oData.form_title+"</a>");
       }
      },
{% end %} {# if is_staff #}
      {% for f in settings['ORDERS_LIST_FIELDS'] %}
        { data: "fields.{{ f['identifier'] }}"},
      {% end %}
      {data: "status",
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         $(nTd).html("<img src='"+oData.status_href+"'> "+sData);
       }
      },
      {% for s in settings['ORDERS_LIST_STATUSES'] %}
        {data: "history.{{ s }}"},
      {% end %}
      {data: "modified",
       fnCreatedCell: function (nTd, sData, oData, iRow, iCol) {
         $(nTd).html($.localtime.toLocalTime(oData.modified));
       }
      }
    ]
  });
});
</script>
{% end %} {# block javascript_code #}
